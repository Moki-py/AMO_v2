# AmoCRM Data Exporter

Приложение для экспорта данных из AmoCRM в JSON-файлы с возможностью просмотра через веб-интерфейс и параллельной выгрузкой.

## Оглавление
- [Основные возможности](#основные-возможности)
- [Структура проекта](#структура-проекта)
- [Требования](#требования)
- [Быстрый старт](#быстрый-старт)
- [Работа с веб-интерфейсом](#работа-с-веб-интерфейсом)
- [Использование CLI](#использование-cli)
- [Описание ключевых файлов](#описание-ключевых-файлов)
- [Экспортируемые данные](#экспортируемые-данные)
- [Решение типичных проблем](#решение-типичных-проблем)
- [Расширение функциональности](#расширение-функциональности)

## Основные возможности

- **Параллельная выгрузка** сделок, контактов, компаний и событий
- **Веб-интерфейс** для просмотра данных и управления выгрузкой
- **Сохранение прогресса** и возможность продолжить прерванную выгрузку
- **Пакетное сохранение** для защиты от потери данных
- **Работа с долгосрочным токеном** AmoCRM
- **Автоматическое создание JSON файлов** в начале работы
- **Встроенный журнал операций** для отслеживания процесса экспорта

## Структура проекта

```
AmoCRM Data Exporter/
│
├── .env                  # Настройки подключения к AmoCRM (создайте из .env.example)
├── .env.example         # Пример файла настроек
├── .gitignore           # Игнорируемые Git файлы
├── README.md            # Документация проекта
├── requirements.txt     # Зависимости Python
│
├── main.py              # Основной скрипт запуска
├── api.py               # Модуль работы с API AmoCRM
├── auth.py              # Модуль аутентификации
├── config.py            # Конфигурация приложения
├── logger.py            # Система логирования
├── storage.py           # Управление хранением данных
├── state_manager.py     # Управление состоянием экспорта
├── parallel_exporter.py # Параллельное выполнение экспорта
├── modern_ui_server.py  # Современный веб-интерфейс
├── ui_server.py         # Базовый веб-интерфейс
├── webhook.py           # Обработка вебхуков AmoCRM
├── simple_server.py     # Простой сервер для запуска веб-интерфейса
│
├── run.sh               # Скрипт запуска для Linux/Mac
├── run.bat              # Скрипт запуска для Windows
├── run_modern_ui.sh     # Скрипт запуска современного UI для Linux/Mac
├── run_modern_ui.bat    # Скрипт запуска современного UI для Windows
│
└── data/                # Директория для хранения данных (создается автоматически)
    ├── deals.json       # Сделки (лиды)
    ├── contacts.json    # Контакты
    ├── companies.json   # Компании
    ├── events.json      # События
    ├── log.json         # Журнал операций
    ├── export_state.json # Состояние экспорта
    └── token.json       # Данные токена доступа
```

## Требования

- Python 3.7 или выше
- Долгосрочный токен доступа AmoCRM
- Установленные зависимости из `requirements.txt`
- Для остановки экспорта через веб-интерфейс: `psutil` (опционально)

## Быстрый старт

1. **Клонирование репозитория**:
   ```bash
   git clone https://github.com/your-repo/amocrm-data-exporter.git
   cd amocrm-data-exporter
   ```

2. **Установка зависимостей**:
   ```bash
   pip install -r requirements.txt
   ```

3. **Настройка подключения**:
   - Создайте файл `.env` на основе `.env.example`:
   ```
   # AmoCRM long-term token - получите в настройках интеграции AmoCRM
   LONGTERM_TOKEN=ваш_долгосрочный_токен_здесь

   # AmoCRM domain - ваш субдомен в AmoCRM
   AMOCRM_DOMAIN=ваш_субдомен.amocrm.ru

   # API domain (из токена, обычно api-a.amocrm.ru)
   API_DOMAIN=api-a.amocrm.ru
   ```

4. **Запуск приложения**:
   - В Linux/Mac:
     ```bash
     bash run.sh
     ```
   - В Windows:
     ```
     run.bat
     ```

Это запустит веб-интерфейс, который откроется в вашем браузере. Через него вы сможете управлять выгрузкой данных.

## Работа с веб-интерфейсом

У приложения есть два веб-интерфейса:

### Современный интерфейс

Для запуска современного интерфейса:
```bash
# Linux/Mac
bash run_modern_ui.sh

# Windows
run_modern_ui.bat
```

Современный интерфейс включает:
- **Дашборд** с количеством выгруженных сущностей
- **Кнопки управления** для запуска/остановки экспорта
- **Журнал операций** с последними событиями
- **Автоматическое обновление** каждые 10 секунд

### Базовый интерфейс

Запускается командой:
```bash
python main.py --server
```

Включает аналогичный функционал в более простом виде.

### Функции веб-интерфейса:

1. **Просмотр статистики**: количество выгруженных сделок, контактов, компаний и событий
2. **Управление экспортом**:
   - Запуск экспорта всех данных
   - Запуск экспорта отдельных типов данных
   - Перезапуск экспорта с начала
   - Остановка всех текущих операций экспорта
3. **Мониторинг процесса**: отображение текущего статуса и прогресса экспорта
4. **Просмотр журнала**: последние операции и ошибки

## Использование CLI

Вы можете управлять экспортом через командную строку:

```bash
# Выгрузить все данные
python main.py --fetch-all

# Выгрузить только сделки
python main.py --fetch-deals

# Выгрузить контакты и компании
python main.py --fetch-contacts --fetch-companies

# Запустить только веб-сервер
python main.py --server

# Перезапустить выгрузку с начала (очистить состояние)
python main.py --fetch-all --force-restart

# Изменить размер пакета сохранения (по умолчанию 10 страниц)
python main.py --fetch-all --batch-size 20
```

### Параметры командной строки:

| Параметр | Описание |
|----------|----------|
| `--fetch-all` | Выгрузить все типы данных |
| `--fetch-deals` | Выгрузить только сделки |
| `--fetch-contacts` | Выгрузить только контакты |
| `--fetch-companies` | Выгрузить только компании |
| `--fetch-events` | Выгрузить только события |
| `--force-restart` | Начать выгрузку с начала (очистить прогресс) |
| `--batch-size N` | Количество страниц перед сохранением |
| `--server` | Запустить веб-сервер |
| `--port N` | Порт для веб-сервера (по умолчанию 8000) |

## Описание ключевых файлов

### Основные модули системы

#### `main.py`
Основной скрипт запуска, который обрабатывает аргументы командной строки и инициализирует все компоненты системы. Координирует работу экспортера и веб-сервера.

#### `api.py`
Модуль для взаимодействия с API AmoCRM. Реализует:
- Управление скоростью запросов (rate limiting)
- Получение данных с пагинацией
- Обработку ошибок API
- Методы для получения сделок, контактов, компаний и событий

#### `auth.py`
Модуль аутентификации, отвечающий за:
- Загрузку и хранение долгосрочного токена AmoCRM
- Валидацию токена
- Обновление токена при необходимости

#### `config.py`
Конфигурация приложения, загружает настройки из .env файла:
- URL и параметры подключения к API
- Пути к файлам данных
- Лимиты запросов к API
- Параметры пагинации

#### `storage.py`
Модуль для работы с хранилищем данных:
- Чтение/запись JSON файлов
- Атомарные операции записи через временные файлы
- Обновление отдельных сущностей
- Получение статистики по выгруженным данным

#### `state_manager.py`
Управление состоянием экспорта:
- Сохранение прогресса выгрузки
- Отслеживание запущенных процессов экспорта
- Возможность продолжить выгрузку с места остановки

#### `parallel_exporter.py`
Параллельная выгрузка данных:
- Многопоточный экспорт разных типов данных
- Контроль за выполнением процессов
- Обработка ошибок и повторные попытки
- Пакетное сохранение для оптимизации производительности

#### `logger.py`
Система логирования:
- Запись логов в JSON-файл
- Буферизация логов до инициализации хранилища
- Ротация логов по сроку давности
- Вывод логов в консоль

### Веб-интерфейсы

#### `modern_ui_server.py`
Современный веб-интерфейс с улучшенным дизайном:
- Адаптивный интерфейс с использованием современных стилей
- Интерактивные элементы управления
- Визуализация статистики
- Автоматическое обновление данных

#### `ui_server.py`
Базовый веб-интерфейс:
- Функциональный интерфейс для управления экспортом
- Отображение статистики и логов
- API для взаимодействия с экспортером

#### `simple_server.py`
Простой сервер для запуска веб-интерфейса:
- Инициализация необходимых компонентов
- Запуск веб-сервера

### Дополнительные модули

#### `webhook.py`
Обработка вебхуков AmoCRM (экспериментальная функция):
- Получение уведомлений об изменениях данных
- Обновление локальных данных при изменениях в AmoCRM

### Скрипты запуска

#### `run.sh` и `run.bat`
Скрипты для быстрого запуска приложения в Linux/Mac и Windows соответственно:
- Проверка наличия зависимостей
- Создание необходимых директорий
- Запуск основного приложения с веб-сервером

#### `run_modern_ui.sh` и `run_modern_ui.bat`
Скрипты для запуска современного веб-интерфейса:
- Установка необходимых зависимостей
- Запуск современного веб-интерфейса

## Экспортируемые данные

Данные сохраняются в формате JSON в директории `data`:

### `deals.json`
Содержит все сделки (лиды) из AmoCRM вместе с:
- Основной информацией о сделке
- Связанными контактами
- Пользовательскими полями
- Событиями и примечаниями

### `contacts.json`
Содержит контакты из AmoCRM с информацией:
- Контактные данные (телефоны, email)
- Пользовательские поля
- Связанные сделки
- Теги и другие атрибуты

### `companies.json`
Содержит компании из AmoCRM с данными:
- Информация о компании
- Связанные контакты
- Пользовательские поля
- Теги и другие атрибуты

### `events.json`
События из AmoCRM:
- Действия пользователей
- Системные события
- Уведомления и примечания

### Служебные файлы

#### `export_state.json`
Хранит состояние экспорта для каждого типа данных:
- Последняя обработанная страница
- Статус завершения
- Время последнего обновления
- Список запущенных экспортов

#### `log.json`
Журнал операций системы:
- Записи о выполненных операциях
- Ошибки и предупреждения
- Информация о прогрессе экспорта

#### `token.json`
Информация о токене доступа:
- Токен доступа
- Срок действия
- Тип токена

## Решение типичных проблем

### Если не работает веб-интерфейс:

1. **Порт занят другим приложением**
   - Убедитесь, что порт 8000 (или указанный вами) не занят
   - Попробуйте указать другой порт: `python main.py --server --port 8080`

2. **Отсутствуют зависимости**
   - Убедитесь, что установлены все пакеты: `pip install -r requirements.txt`
   - Особенно проверьте наличие `psutil` для функции остановки процессов

3. **Проблемы с правами доступа**
   - Убедитесь, что у приложения есть права на создание и запись файлов в директорию `data`

### Если выгрузка останавливается или завершается с ошибкой:

1. **Проблемы с токеном**
   - Проверьте валидность токена и его права доступа
   - Убедитесь, что токен не истек и имеет необходимые права

2. **Ошибки API**
   - Посмотрите логи на наличие ошибок API
   - Проверьте лимиты запросов в AmoCRM

3. **Прерывание выгрузки**
   - Запустите выгрузку повторно - она продолжится с места остановки
   - Если нужно начать заново, используйте `--force-restart`

### Если данные не появляются в JSON файлах:

1. **Проверьте наличие файлов**
   - Убедитесь, что файлы созданы в директории `data`
   - Проверьте права доступа к директории

2. **Логи выгрузки**
   - Посмотрите логи выгрузки в `data/log.json` или в консоли
   - Проверьте, есть ли ошибки доступа к API

3. **Размер файлов**
   - Убедитесь, что файлы не пустые и содержат данные
   - Проверьте, что JSON-структура корректна

## Расширение функциональности

### Добавление новых типов данных

Для добавления нового типа данных (например, "Задачи"):

1. Добавьте новый метод в `api.py`:
   ```python
   def get_tasks_page(self, page: int) -> Tuple[List[Dict[str, Any]], bool]:
       """Get a specific page of tasks"""
       return self._get_entity_page('tasks', page)
   ```

2. Добавьте файл в конфигурацию (`config.py`):
   ```python
   TASKS_FILE = os.path.join(DATA_DIR, 'tasks.json')
   ```

3. Добавьте метод экспорта в `parallel_exporter.py`:
   ```python
   def export_tasks(self, force_restart: bool = False, batch_save: bool = True, batch_size: int = 10):
       """Export tasks in a separate thread"""
       self._start_export_thread('tasks', self._export_tasks_worker, force_restart, batch_save, batch_size)

   def _export_tasks_worker(self, batch_save: bool = True, batch_size: int = 10):
       """Worker function for exporting tasks"""
       try:
           self._export_entities_worker('tasks', self.api.get_tasks_page, batch_save, batch_size)
       except Exception as e:
           log_event('exporter', 'error', f'Error in tasks export worker: {e}')
       finally:
           self.state_manager.mark_export_stopped('tasks')
   ```

4. Добавьте опцию в `main.py`:
   ```python
   parser.add_argument('--fetch-tasks', action='store_true', help='Fetch only tasks')
   ```

### Оптимизация производительности

Для ускорения экспорта данных:

1. **Увеличьте количество страниц в пакете**:
   ```bash
   python main.py --fetch-all --batch-size 30
   ```

2. **Настройте лимиты запросов** в `config.py`:
   ```python
   MAX_REQUESTS_PER_SECOND = 10  # Увеличьте в соответствии с лимитами AmoCRM
   ```

3. **Измените размер страницы**:
   ```python
   PAGE_SIZE = 100  # Максимально допустимое значение для AmoCRM
   ```

### Дополнительная обработка данных

Вы можете добавить дополнительную обработку данных перед сохранением, например:

1. Фильтрацию ненужных полей
2. Трансформацию данных в другой формат
3. Обогащение данных из других источников

Для этого модифицируйте метод `_export_entities_worker` в `parallel_exporter.py`.