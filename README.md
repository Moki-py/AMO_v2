# AmoCRM Data Exporter

Приложение для экспорта данных из AmoCRM в JSON-файлы с возможностью просмотра через веб-интерфейс и параллельной выгрузкой. Поддерживает сохранение в MongoDB.

## Оглавление
- [Основные возможности](#основные-возможности)
- [Структура проекта](#структура-проекта)
- [Требования](#требования)
- [Быстрый старт](#быстрый-старт)
- [Docker](#docker)
- [Работа с веб-интерфейсом](#работа-с-веб-интерфейсом)
- [Использование CLI](#использование-cli)
- [Описание ключевых файлов](#описание-ключевых-файлов)
- [Экспортируемые данные](#экспортируемые-данные)
- [Решение типичных проблем](#решение-типичных-проблем)
- [Расширение функциональности](#расширение-функциональности)

## Основные возможности

- **Параллельная выгрузка** сделок, контактов, компаний и событий
- **Веб-интерфейс** для просмотра данных и управления выгрузкой
- **Сохранение прогресса** и возможность продолжить прерванную выгрузку
- **Пакетное сохранение** для защиты от потери данных
- **Работа с долгосрочным токеном** AmoCRM
- **Автоматическое создание JSON файлов** в начале работы
- **Встроенный журнал операций** для отслеживания процесса экспорта
- **Интеграция с MongoDB** для хранения данных в базе данных
- **Docker образы** для удобного развертывания

## Структура проекта

```
AMO_v2/
│
├── .env                     # Настройки подключения к AmoCRM и MongoDB
├── .gitignore               # Игнорируемые Git файлы
├── README.md                # Документация проекта
├── requirements.txt         # Зависимости Python
├── docker-compose.yml       # Конфигурация для запуска в Docker с MongoDB
├── local.docker-compose.yml # Конфигурация для локальной MongoDB
├── Dockerfile               # Инструкции для сборки Docker образа
│
├── api.py                   # Модуль работы с API AmoCRM
├── auth.py                  # Модуль аутентификации
├── config.py                # Конфигурация приложения
├── logger.py                # Система логирования
├── storage.py               # Управление хранением данных
├── state_manager.py         # Управление состоянием экспорта
├── parallel_exporter.py     # Параллельное выполнение экспорта
├── modern_ui_server.py      # Современный веб-интерфейс на FastAPI
│
├── run_modern_ui.sh         # Скрипт запуска современного UI для Linux/Mac
├── run_modern_ui.bat        # Скрипт запуска современного UI для Windows
│
├── templates/               # Шаблоны для веб-интерфейса
│
└── data/                    # Директория для хранения данных (создается автоматически)
    ├── deals.json           # Сделки (лиды)
    ├── contacts.json        # Контакты
    ├── companies.json       # Компании
    ├── events.json          # События
    ├── log.json             # Журнал операций
    ├── export_state.json    # Состояние экспорта
    └── token.json           # Данные токена доступа
```

## Требования

- Python 3.7 или выше
- Долгосрочный токен доступа AmoCRM
- Установленные зависимости из `requirements.txt`:
  - requests
  - python-dotenv
  - APScheduler
  - fastapi
  - uvicorn
  - jinja2
  - pydantic-settings
  - pymongo (для работы с MongoDB)
- (опционально) Docker и docker-compose для запуска в контейнере
- (опционально) MongoDB для хранения данных в базе

## Быстрый старт

1. **Клонирование репозитория**:
   ```bash
   git clone https://github.com/your-repo/amocrm-data-exporter.git
   cd amocrm-data-exporter
   ```

2. **Установка зависимостей**:
   ```bash
   pip install -r requirements.txt
   ```

3. **Настройка подключения**:
   - Создайте файл `.env` с вашими настройками:
   ```
   # AmoCRM long-term token - получите в настройках интеграции AmoCRM
   LONGTERM_TOKEN=ваш_долгосрочный_токен_здесь

   # AmoCRM domain - ваш субдомен в AmoCRM
   AMOCRM_DOMAIN=ваш_субдомен.amocrm.ru

   # API domain (из токена, обычно api-a.amocrm.ru)
   API_DOMAIN=api-a.amocrm.ru

   # MongoDB settings (опционально)
   MONGO_URL=mongodb://localhost:27017/amo_db
   ```

4. **Запуск приложения**:
   - В Linux/Mac:
     ```bash
     bash run_modern_ui.sh
     ```
   - В Windows:
     ```
     run_modern_ui.bat
     ```

## Docker

Проект поддерживает запуск через Docker с интеграцией MongoDB.

### Запуск полного стека

```bash
# Запуск приложения с MongoDB и Mongo Express
docker-compose up -d
```

Это запустит:
- Приложение AMO Data Exporter на порту 8000
- MongoDB на порту 27017
- Mongo Express (веб-интерфейс для MongoDB) на порту 8081

### Запуск только MongoDB для локальной разработки

```bash
# Запуск только MongoDB и Mongo Express
docker-compose -f local.docker-compose.yml up -d
```

### Доступ к Mongo Express

Mongo Express будет доступен по адресу: http://localhost:8081
- Логин: admin
- Пароль: admin

## Работа с веб-интерфейсом

### Современный интерфейс

Для запуска современного интерфейса на FastAPI:
```bash
# Linux/Mac
bash run_modern_ui.sh

# Windows
run_modern_ui.bat
```

Современный интерфейс включает:
- **Дашборд** с количеством выгруженных сущностей
- **Кнопки управления** для запуска/остановки экспорта
- **Журнал операций** с последними событиями
- **Автоматическое обновление** каждые 10 секунд

### Функции веб-интерфейса:

1. **Просмотр статистики**: количество выгруженных сделок, контактов, компаний и событий
2. **Управление экспортом**:
   - Запуск экспорта всех данных
   - Запуск экспорта отдельных типов данных
   - Перезапуск экспорта с начала
   - Остановка всех текущих операций экспорта
3. **Мониторинг процесса**: отображение текущего статуса и прогресса экспорта
4. **Просмотр журнала**: последние операции и ошибки
5. **Управление хранилищем**: переключение между JSON и MongoDB

## Использование CLI

Вы можете управлять экспортом через командную строку:

```bash
# Выгрузить все данные
python modern_ui_server.py --fetch-all

# Выгрузить только сделки
python modern_ui_server.py --fetch-deals

# Выгрузить контакты и компании
python modern_ui_server.py --fetch-contacts --fetch-companies

# Запустить только веб-сервер
python modern_ui_server.py

# Перезапустить выгрузку с начала (очистить состояние)
python modern_ui_server.py --fetch-all --force-restart

# Изменить размер пакета сохранения (по умолчанию 10 страниц)
python modern_ui_server.py --fetch-all --batch-size 20
```

### Параметры командной строки:

| Параметр | Описание |
|----------|----------|
| `--fetch-all` | Выгрузить все типы данных |
| `--fetch-deals` | Выгрузить только сделки |
| `--fetch-contacts` | Выгрузить только контакты |
| `--fetch-companies` | Выгрузить только компании |
| `--fetch-events` | Выгрузить только события |
| `--force-restart` | Начать выгрузку с начала (очистить прогресс) |
| `--batch-size N` | Количество страниц перед сохранением |
| `--port N` | Порт для веб-сервера (по умолчанию 8000) |
| `--use-mongo` | Использовать MongoDB вместо JSON-файлов |

## Описание ключевых файлов

### Основные модули системы

#### `modern_ui_server.py`
Основной скрипт запуска современного веб-интерфейса на FastAPI. Обрабатывает аргументы командной строки и инициализирует все компоненты системы.

#### `api.py`
Модуль для взаимодействия с API AmoCRM. Реализует:
- Управление скоростью запросов (rate limiting)
- Получение данных с пагинацией
- Обработку ошибок API
- Методы для получения сделок, контактов, компаний и событий

#### `auth.py`
Модуль аутентификации, отвечающий за:
- Загрузку и хранение долгосрочного токена AmoCRM
- Валидацию токена
- Обновление токена при необходимости

#### `config.py`
Конфигурация приложения, загружает настройки из .env файла:
- URL и параметры подключения к API
- Пути к файлам данных
- Лимиты запросов к API
- Параметры пагинации
- Настройки подключения к MongoDB

#### `storage.py`
Модуль для работы с хранилищем данных:
- Чтение/запись JSON файлов
- Атомарные операции записи через временные файлы
- Обновление отдельных сущностей
- Получение статистики по выгруженным данным
- Поддержка MongoDB как альтернативного хранилища

#### `state_manager.py`
Управление состоянием экспорта:
- Сохранение прогресса выгрузки
- Отслеживание запущенных процессов экспорта
- Возможность продолжить выгрузку с места остановки

#### `parallel_exporter.py`
Параллельная выгрузка данных:
- Многопоточный экспорт разных типов данных
- Контроль за выполнением процессов
- Обработка ошибок и повторные попытки
- Пакетное сохранение для оптимизации производительности

#### `logger.py`
Система логирования:
- Запись логов в JSON-файл или MongoDB
- Буферизация логов до инициализации хранилища
- Ротация логов по сроку давности
- Вывод логов в консоль

## Экспортируемые данные

Данные сохраняются в формате JSON в директории `data` или в MongoDB:

### `deals.json` / Коллекция `deals`
Содержит все сделки (лиды) из AmoCRM вместе с:
- Основной информацией о сделке
- Связанными контактами
- Пользовательскими полями
- Событиями и примечаниями

### `contacts.json` / Коллекция `contacts`
Содержит контакты из AmoCRM с информацией:
- Контактные данные (телефоны, email)
- Пользовательские поля
- Связанные сделки
- Теги и другие атрибуты

### `companies.json` / Коллекция `companies`
Содержит компании из AmoCRM с данными:
- Информация о компании
- Связанные контакты
- Пользовательские поля
- Теги и другие атрибуты

### `events.json` / Коллекция `events`
События из AmoCRM:
- Действия пользователей
- Системные события
- Уведомления и примечания

### Служебные данные

#### `export_state.json` / Коллекция `export_state`
Хранит состояние экспорта для каждого типа данных:
- Последняя обработанная страница
- Статус завершения
- Время последнего обновления
- Список запущенных экспортов

#### `log.json` / Коллекция `logs`
Журнал операций системы:
- Записи о выполненных операциях
- Ошибки и предупреждения
- Информация о прогрессе экспорта

#### `token.json` / Коллекция `tokens`
Информация о токене доступа:
- Токен доступа
- Срок действия
- Тип токена

## Решение типичных проблем

### Если не работает веб-интерфейс:

1. **Порт занят другим приложением**
   - Убедитесь, что порт 8000 (или указанный вами) не занят
   - Попробуйте указать другой порт: `python modern_ui_server.py --port 8080`

2. **Отсутствуют зависимости**
   - Убедитесь, что установлены все пакеты: `pip install -r requirements.txt`

3. **Проблемы с правами доступа**
   - Убедитесь, что у приложения есть права на создание и запись файлов в директорию `data`

### Если выгрузка останавливается или завершается с ошибкой:

1. **Проблемы с токеном**
   - Проверьте валидность токена и его права доступа
   - Убедитесь, что токен не истек и имеет необходимые права

2. **Ошибки API**
   - Посмотрите логи на наличие ошибок API
   - Проверьте лимиты запросов в AmoCRM

3. **Прерывание выгрузки**
   - Запустите выгрузку повторно - она продолжится с места остановки
   - Если нужно начать заново, используйте `--force-restart`

### Проблемы с MongoDB:

1. **Нет подключения к MongoDB**
   - Убедитесь, что MongoDB запущена и доступна
   - Проверьте настройки подключения в файле .env
   - При использовании Docker убедитесь, что контейнеры запущены и сеть настроена

2. **Ошибки при сохранении данных**
   - Проверьте права доступа MongoDB
   - Убедитесь, что у MongoDB достаточно места на диске

## Расширение функциональности

### Добавление новых типов данных

Для добавления нового типа данных (например, "Задачи"):

1. Добавьте новый метод в `api.py`:
   ```python
   def get_tasks_page(self, page: int) -> tuple[list[dict[str, Any]], bool]:
       """Get a specific page of tasks"""
       return self._get_entity_page('tasks', page)
   ```

2. Добавьте метод экспорта в `parallel_exporter.py`:
   ```python
   def export_tasks(self, force_restart: bool = False, batch_save: bool = True, batch_size: int = 10):
       """Export tasks in a separate thread"""
       self._start_export_thread('tasks', self._export_tasks_worker, force_restart, batch_save, batch_size)

   def _export_tasks_worker(self, batch_save: bool = True, batch_size: int = 10):
       """Worker function for exporting tasks"""
       try:
           self._export_entities_worker('tasks', self.api.get_tasks_page, batch_save, batch_size)
       except Exception as e:
           log_event('exporter', 'error', f'Error in tasks export worker: {e}')
       finally:
           self.state_manager.mark_export_stopped('tasks')
   ```

3. Обновите конфигурацию в `config.py` для нового типа данных

4. Добавьте опцию в `modern_ui_server.py`

### Использование альтернативных баз данных

В дополнение к MongoDB можно добавить поддержку других баз данных:

1. Создайте новый класс-адаптер в `storage.py` для работы с нужной БД
2. Реализуйте методы для чтения, записи и обновления данных
3. Обновите конфигурацию и добавьте параметры для новой БД

### Оптимизация производительности

Для ускорения экспорта данных:

1. **Увеличьте количество страниц в пакете**:
   ```bash
   python modern_ui_server.py --fetch-all --batch-size 30
   ```

2. **Настройте лимиты запросов** в `config.py`:
   ```python
   MAX_REQUESTS_PER_SECOND = 10  # Увеличьте в соответствии с лимитами AmoCRM
   ```

3. **Измените размер страницы**:
   ```python
   PAGE_SIZE = 100  # Максимально допустимое значение для AmoCRM
   ```

4. **Используйте индексы в MongoDB** для ускорения запросов